<?php
require_once('connection.php');
require_once('functions.php');

session_start();

$message = "";
if(isset($_GET["signout"]) ==1) { 
	session_destroy();
	$message = "You have successfully logged out! ";
}

$error = "";
if(isset($_POST['submit']) == "Sign In" && isset($_POST['loginemail']) && isset($_POST['loginpassword'])) {
	$loginemail = $database->mysql_prep($_POST['loginemail']);
	$loginpassword = $database->mysql_prep($_POST['loginpassword']);

  $sqlCheckAdmin = "Select * from admin where email = '$loginemail'";
  $admin1 = $database->query($sqlCheckAdmin);
  $rowAdmin = $database->fetch_array($admin1);
  if(!$rowAdmin) {
    $loginpassword = md5(md5($loginemail).$loginpassword);
  }

	$sql_login_authenticated = "Select * from user where email = '$loginemail' and password = '$loginpassword' and authenticated = true LIMIT 1";
  $sql_login_notauthenticated = "Select * from user where email = '$loginemail' and password = '$loginpassword' and authenticated = false LIMIT 1";
	$sql_login_user = "Select * from admin where email = '$loginemail' and password = '$loginpassword' LIMIT 1";

	$result1 = $database->query($sql_login_authenticated);
	$result2 = $database->query($sql_login_user);
  $result3 = $database->query($sql_login_notauthenticated);

	$row1 = $database->fetch_array($result1);
	$row2 = $database->fetch_array($result2);
  $row3 = $database->fetch_array($result3);

	if ($loginemail === "" || $loginpassword === "") {
		echo "<script type=\"text/javascript\">
            alert('Please enter username and password');
            </script>";
	}elseif($row1) {
		$_SESSION['id'] = $row['id'];
		redirect_to('userpage.php');
	
	}elseif($row2) {
		$_SESSION['id'] = $row['id'];
		redirect_to('adminpage.php');
	}elseif ($row3) {
    $_SESSION['id'] = $row['id'];
    redirect_to('regularuserpage.php');
  }
	else{
            $error .= 'Username/password combination not incorrect<br>';
        }

}

  $name = $email = $password = $cpassword = "";
  $name_err = $emailErr = $passwordErr = $cpasswordErr = "";
  $success = "";
  $requestedtoadd = true;

if(isset($_POST['submit']) =='Sign Up' && isset($_POST['name']) &&isset($_POST['email']) && isset($_POST['password']) && isset($_POST['cpassword'])) {

      $name = $database->mysql_entities_fix_string(test_input($_POST['name']));
      $email = $database->mysql_entities_fix_string(test_input($_POST['email']));

      if(empty($_POST['name'])) {
      	$error .= "You must enter your name<br>";
      }
      if(empty($_POST['email'])) {
      	$error .= "You must enter your email<br>";
      }
      if(empty($_POST['password'])) {
      	$error .= "You must enter you password<br>";
      }

      if (!preg_match("/^[A-Za-z ]*$/", $name)) {
        $error .= "Name must be only letters and white space<br>";
    	}
      if (!filter_var($email, FILTER_VALIDATE_EMAIL) && !empty($_POST['email'])) {
        $error .= "Invalid email format<br>";
      }

    if(($_POST["password"] == $_POST["cpassword"]) && !empty($_POST['password'])) {
    	$password = $database->mysql_entities_fix_string(test_input($_POST["password"]));
    	$cpassword = $database->mysql_entities_fix_string(test_input($_POST["cpassword"]));
    	if (strlen($_POST["password"]) < '8') {
        	$error .= "Your Password Must Contain At Least 8 Characters!<br>";
    		}
    	elseif(!preg_match("#[0-9]+#",$password)) {
        	$error .= "Your Password Must Contain At Least 1 Number!<br>";
    		}
    	elseif(!preg_match("#[A-Z]+#",$password)) {
        	$error .= "Your Password Must Contain At Least 1 Capital Letter!<br>";
    		}
    	elseif(!preg_match("#[a-z]+#",$password)) {
        	$error .= "Your Password Must Contain At Least 1 Lowercase Letter!<br>";
    		}
	}
	if($_POST["password"] !== $_POST["cpassword"]) {
    		$error .= "Password did not match<br>";
	}
	$password = md5((md5($_POST['email']).$password));

	if($error == "") {
		
		$check_duplicate = $database->query("select * from `user` where email = '".$database->mysql_prep($email)."'");
		$username_result = $database->num_rows($check_duplicate);
		
    $sql_insert = "";
    $stmt = null;
    if(isset($_POST['checkbox']) && !$username_result) {
       $sql_insert = 'insert into user (name, email, password, requestedAdd) values (?, ?, ?, ?)';
       $stmt = $database->prepare_query($sql_insert);
       $stmt->bind_param('ssss', $name, $email, $password, $requestedtoadd);
       echo "<script type=\"text/javascript\">
            alert('You have been successfully registered. Your request to add infected file is pending. Please login');
            </script>";
      }elseif (!$username_result) {
        $sql_insert = 'insert into user (name, email, password) values (?, ?, ?)';
        $stmt = $database->prepare_query($sql_insert);
        $stmt->bind_param('sss', $name, $email, $password);
        echo "<script type=\"text/javascript\">
            alert('You have been successfully registered. Please login');
            </script>";
      }
		if(!$username_result) {
		$stmt->execute();
		$stmt->close();
 		}else{
  			$error = "That email address already registered.";
 	}
	}
	$database->close_connection();

}
?>

<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Malware Detector</title>
	<link href="css/bootstrap.min.css" rel="stylesheet">
	<link href="main.css" media = "all" rel="stylesheet" type="text/css" />
</head>
<body data-spy="scroll" data-target=".navbar-collapse">

  <div class="navbar navbar-default navbar-fixed-top">
  
  	<div class="container">
  	
  		<div class="navbar-header">
  		
  			<button class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
  			
  				<span class="icon-bar"></span>
  				
  				<span class="icon-bar"></span>
  				
  				<span class="icon-bar"></span>
  					
  			</button>
  			
  			<a href="index.php" class="navbar-brand">Malware Detector</a>
  			
  		</div>
  		
  		<div class="collapse navbar-collapse">
  		
  			<form class="navbar-form navbar-right" method="post"> 
  			
  				<div class="form-group">
  					<label>Email</label>
  					<input type="email" name="loginemail" placeholder="Email" class="form-control"
  					 value="<?php
  					 if(isset($_POST['loginemail'])){
  					 	echo $_POST['loginemail'];
  					 }else{
  					 	echo "";
   					 }

  					  ?>" />
  																								   
  				</div>
  				
  				<div class="form-group">
  					<label>Password</label>
  					<input type="password" name="loginpassword" placeholder="Password" class="form-control" />
  																											
  				</div>
  				<input type="submit" name= "submit" class="btn btn-success" value="Log In">
  				
  			</form>
  			
  		</div>
  		
  	</div>	
  	
  </div>
  
 <div class="container contentContainer" id="topContainer">
  		<div class="row">
  		
  			<div class="col-md-6 col-md-offset-3" id="topRow">
 			 
 			 <h1 class="marginTop">Malware Detector</h1>
 			 
 			 <p class="lead" id="desc">Test your file. Check if it contains viruses</p>
  			 <?php
 			 	if ($error) {
 			 	
 			 	echo '<div class="alert alert-danger">'.addslashes($error).'</div>';
 			 	
 			 	}
 			 	
 			 	if ($success) {
 			 	
 			 	echo '<div class="alert alert-success">'.addslashes($success).'</div>';
 			 	
 			 	 }
 			 	 if ($message) {
 			 	echo '<div class="alert alert-success">'.addslashes($message).'</div>';
 			 	
 			 	 }
 			 ?> 
 			 <p class="bold marginTop">Interested? Sign Up Below!</p>
 			 
 			 <form class="marginTop" method="post"> 

 			 	<div class="form-group">
 			 	
  					<label for="name">Your Name</label><span class="error">*<?php echo "$name_err"; ?></span>
  					
  				<input type="text" name="name" class="form-control" placeholder="Your Name"
  				value="<?php
  					 if(isset($_POST['name'])){
  					 	echo $_POST['name'];
  					 }else{
  					 	echo "";
   					 }

  					  ?>" />
  																							   
				</div>
 			 
 			 	<div class="form-group">
 			 	
  					<label for="email">Email Address</label><span class="error">*<?php echo "$emailErr"; ?></span>
  					
  				<input type="email" name="email" class="form-control" placeholder="Your Email" 
  				value="<?php
  					 if(isset($_POST['email'])){
  					 	echo $_POST['email'];
  					 }else{
  					 	echo "";
   					 }

  					  ?>" />
  																							   
				</div>
				
				<div class="form-group">
 			 	
  					<label for="password">Password</label><span class="error">*<?php echo "$passwordErr"; ?></span>
  					
  				<input type="password" name="password" class="form-control" placeholder="Password" />
  				<div class="form-group">
 			 	
  					<label for="cpassword">Confirm Password</label><span class="error">*<?php echo "$cpasswordErr"; ?></span>
  					
  				<input type="password" name="cpassword" class="form-control" placeholder="Confirm Password" />
  				<br>
          <input type="checkbox" name="checkbox" /> <label style="color: #0083ff; background-color: #ebf4f3; border-radius: 5px; font-size: 20px;"> Would like to add virus infected file?</label>
				</div>

 			 	<input type="submit" name="submit" value="Sign Up" class="btn btn-success btn-lg marginTop"/> 
 			 		 <br>
 			 		 <br>
 			 		<p>Already have account? Sign In</p>
 			 </form>
 			 
 			 </div>
 		 
		</div>
		
  </div>
<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    
    <script src="js/bootstrap.min.js"></script>
    
    <script>
    
    
		$(".contentContainer").css("min-height",$(window).height());
    
    </script>
</body>
</html>


