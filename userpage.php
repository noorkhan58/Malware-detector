<?php
error_reporting(E_ERROR | E_PARSE);
require_once('connection.php');
require_once('functions.php');

session_start();

$found_virus = "";
$notfound_virus = "";
$error = "";
$inserted = "";

        //Checking file name is not empty
    if (isset($_POST['notsurefile']) == 'Submit') {

    $file_name = $_FILES['file']['name'];
    $file_size = $_FILES['file']['size'];
    $file_type = $_FILES['file']['type'];
    $file_error = $_FILES['file']['error'];
    $file_contents = file_get_contents($_FILES['file']['tmp_name']);
    $contents = "";
    $virus_found = false;

        //Checking file name is not empty
        if(isset($file_name) && !empty($file_name)) {

                if (check_file_error($file_error)) {

                    if (check_file_size($file_size)) {

                       for($i = 0; $i < $file_size; $i++) { 

                            // get the current ASCII character representation of the current byte
                            $asciiCharacter = $file_contents[$i];

                            $contents .= ascii2hex($asciiCharacter);    
                        }
                        
                        $contents = str_replace(' ', '', $contents);
                        
                        $sql = "Select signature from malware";
                        $result = $database->query($sql);
                        while ($row = mysqli_fetch_array($result, MYSQLI_BOTH)) {
                          
                          $a = $row['signature'];
                          if(strpos($contents, $a) !== false) {
                            $found_virus =  "Your file contain virus";
                            $virus_found = true;
                            break;
                          }
                        }

                        if(!$virus_found) {
                          $notfound_virus  = "Your file is safe, contains no virus";
                        }

                    }

                }

        }else {
            $error =  "Please choose a file";
        }
    }

    if (isset($_POST['surelyinfected']) == 'Submit') {
     $file_name = $_FILES['file']['name'];
    $file_size = $_FILES['file']['size'];
    $file_type = $_FILES['file']['type'];
    $file_error = $_FILES['file']['error'];
    $file_contents = file_get_contents($_FILES['file']['tmp_name']);
    $malware_name = $_POST['malware'];
    $contents = "";

        //Checking file name is not empty
        if(isset($file_name) && !empty($file_name)) {

            if(!empty($malware_name)) {

                if (check_file_error($file_error)) {

                    if (check_file_size($file_size)) {

                       for($i = 0; $i < $file_size; $i++) { 

                            // get the current ASCII character representation of the current byte
                            $asciiCharacter = $file_contents[$i];

                            $contents .= ascii2hex($asciiCharacter);    
                        }
                        $contents = str_replace(' ', '', $contents);
                        $signature = $database->mysql_prep(substr($contents, 0, 20));
                        $sql = "insert into malware values('$malware_name', '$signature')";
                        $result = $database->query($sql);
                        $inserted =  "Successfully inserted.";

                    }

                }
            }else {
                $error .= "Please enter malware name";
            }

        }else {
            $error .= "Please choose a file";
        }

    }
?>

<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Malware Detector</title>
	<link href="css/bootstrap.min.css" rel="stylesheet">
   <link href="main.css" media = "all" rel="stylesheet" type="text/css" />

	</head>
<body data-spy="scroll" data-target=".navbar-collapse">

  <div class="navbar navbar-default navbar-fixed-top">
  
  	<div class="container">
  	
  		<div class="navbar-header">
  			
  			<a class="navbar-brand">Malware Detector</a>
  			
  		</div>
  		
  		<div class="collapse navbar-collapse pull-right">
  		
  			<ul class=" navbar-nav nav"> 
  			 
  			     <li><a href="index.php?signout=1">Sign Out</a></li>
  				</ul>
  			
  		</div>
  		
  	</div>	
  	
  </div>
  
 <div class="container contentContainer" id="topContainer">
  		<div class="row">
 			 <br><br><br><br><br>
         <div class="col-md-4 virus">
          <h4 id="text">Select Your File: </h4>
         <form method="POST" enctype="multipart/form-data" class="virusFile">
        <input type="file" name="file" id="checkmalware" class="input-large form-control"><br><br>
        <input type="submit" name = "notsurefile" class="form-control btn btn-success btnAdmin" value="Submit">
        </form>
        </div>
        <div class="col-md-4 virus1">
          <h4 id="text">Select Virus Infected File </h4>
        <form method="POST" enctype="multipart/form-data">
        <input type="text" name="malware" placeholder="Malware name" class="form-control"><br>
        <input type="file" name="file" id="checkmalware" class="input-large form-control"><br><br>
         <input type="submit" name = "surelyinfected" class="form-control btn btn-success btnAdmin" value="Submit">
        </form>
        </div>
 			 
 			 </div>
       <br><br>
       <?php 
        if ($notfound_virus) {
        
        echo '<div class="alert alert-success alertAdmin">'.addslashes($notfound_virus).'</div>';
        
         }
         if ($found_virus) {
        
        echo '<div class="alert alert-danger alertAdmin">'.addslashes($found_virus).'</div>';
        
         }
         if ($error) {
        
        echo '<div class="alert alert-danger alertAdmin">'.addslashes($error).'</div>';
        
         }
         if ($inserted) {
        
        echo '<div class="alert alert-success">'.addslashes($inserted).'</div>';
        
         }
          ?>
 		 
		</div>
		
  </div>
<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/bootstrap.min.js"></script>
    <script>   
		$(".contentContainer").css("min-height",$(window).height());
    </script>
</body>
</html>
