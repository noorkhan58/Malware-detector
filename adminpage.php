<?php
error_reporting(E_ERROR | E_PARSE);
require_once('connection.php');
require_once('functions.php');

session_start();

$found_virus = "";
$notfound_virus = "";
$error = "";
$inserted = "";


if (isset($_POST['notsurefile']) == 'Submit') {

    $file_name = $_FILES['file']['name'];
    $file_size = $_FILES['file']['size'];
    $file_type = $_FILES['file']['type'];
    $file_error = $_FILES['file']['error'];
    $file_contents = file_get_contents($_FILES['file']['tmp_name']);
    $contents = "";
    $virus_found = false;

        //Checking file name is not empty
        if(isset($file_name) && !empty($file_name)) {

                if (check_file_error($file_error)) {

                    if (check_file_size($file_size)) {

                       for($i = 0; $i < $file_size; $i++) { 

                            // get the current ASCII character representation of the current byte
                            $asciiCharacter = $file_contents[$i];

                            $contents .= ascii2hex($asciiCharacter);    
                        }
                        
                        $contents = str_replace(' ', '', $contents);
                        
                        $sql = "Select signature from malware";
                        $result = $database->query($sql);
                        while ($row = mysqli_fetch_array($result, MYSQLI_BOTH)) {
                          
                          $a = $row['signature'];
                          if(strpos($contents, $a) !== false) {
                            $found_virus =  "Your file contain virus";
                            $virus_found = true;
                            break;
                          }
                        }

                        if(!$virus_found) {
                          $notfound_virus  = "Your file is safe, contains no virus";
                        }

                    }

                }

        }else {
            $error =  "Please choose a file";
        }
    }
    if (isset($_POST['surelyinfected']) == 'Submit') {
     $file_name = $_FILES['file']['name'];
    $file_size = $_FILES['file']['size'];
    $file_type = $_FILES['file']['type'];
    $file_error = $_FILES['file']['error'];
    $file_contents = file_get_contents($_FILES['file']['tmp_name']);
    $malware_name = $_POST['malware'];
    $contents = "";

        //Checking file name is not empty
        if(isset($file_name) && !empty($file_name)) {

            if(!empty($malware_name)) {

                if (check_file_error($file_error)) {

                    if (check_file_size($file_size)) {

                       for($i = 0; $i < $file_size; $i++) { 

                            // get the current ASCII character representation of the current byte
                            $asciiCharacter = $file_contents[$i];

                            $contents .= ascii2hex($asciiCharacter);    
                        }
                        $contents = str_replace(' ', '', $contents);
                        $signature = $database->mysql_prep(substr($contents, 0, 20));
                        $sql = "insert into usermalware values('$malware_name', '$signature')";
                        $result = $database->check_query($sql);
                        if(!$result) {
                          $error .= "Whoops something wrong, malware not added"; 
                        }else{
                          $inserted =  "Successfully inserted.";
                        }

                    }

                }
            }else {
                $error .= "Please enter malware name";
            }

        }else {
            $error .= "Please choose a file";
        }

    }


    $sql_query = "Select `name`, `email` from user where requestedAdd = 1";
    $result = $database->query($sql_query);
    $rows = $database->num_rows($result);
    $row = $database->fetch_array($result);

?>

<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Malware Detector</title>
	<link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="main.css" media = "all" rel="stylesheet" type="text/css" />

</head>
<body data-spy="scroll" data-target=".navbar-collapse">

  <div class="navbar navbar-default navbar-fixed-top">
  
  	<div class="container">
  	
  		<div class="navbar-header">
  			
  			<a class="navbar-brand">Malware Detector</a>
  			
  		</div>
  		
  		<div class="collapse navbar-collapse pull-right">
  		
  			<ul class=" navbar-nav nav">

            <li style="font-weight: bold; margin-top: 16px; margin-right: 10px;">Admin Page</li>
  			 
  			     <li><a href="index.php?signout=1">Sign Out</a></li>
  				</ul>
  			
  		</div>
  		
  	</div>	
  	
  </div>  
  
 <div class="container contentContainer" id="topContainer">
  		<br><br><br><br><br>
         <div class="col-md-4 virus">
          <h4 id="text">Select Your File: </h4>
         <form method="POST" enctype="multipart/form-data" class="virusFile">
        <input type="file" name="file" id="checkmalware" class="input-large form-control"><br><br>
        <input type="submit" name = "notsurefile" class="form-control btn btn-success btnAdmin" value="Submit">
       </form>
        </div>
        <div class="col-md-4 virus1">
          <h4 id="text">Select Virus Infected File </h4>
      <form method="POST" enctype="multipart/form-data" class="virusFile">
        <input type="text" name="malware" placeholder="Malware name" class="form-control"><br>
        <input type="file" name="file" id="checkmalware" class="input-large form-control"><br><br>
        <input type="submit" name = "surelyinfected" class="form-control btn btn-success btnAdmin" value="Submit">
        </form>
        <br><br>
        <?php
        if ($error) {
        
        echo '<div class="alert alert-danger">'.addslashes($error).'</div>';
        
        }
        
        if ($found_virus) {
        
        echo '<div class="alert alert-danger">'.addslashes($found_virus).'</div>';
        
         }
         if ($notfound_virus) {
        
        echo '<div class="alert alert-success">'.addslashes($notfound_virus).'</div>';
        
         }
         if ($inserted) {
        
        echo '<div class="alert alert-success">'.addslashes($inserted).'</div>';
        
         }
       ?>
       <h3 style="color: #83ff00">Pending Requested User: </h3><br>


          <?php 
        for ($j = 0 ; $j < $rows ; $j++)
            {
              $result->data_seek($j);
              $row = $result->fetch_array(MYSQLI_NUM);

              echo <<<_END
              <pre style = "margin-left: -50px; margin-bottom: 20px; width: 400px; text-align: left; height: 235px;">
              Name: $row[0]
              Email: $row[1]
              <form action="adminpage.php" method="post">
              <input type= "hidden" name = "adduser" value = 'yes'>
              <input type= "hidden" name = "email" value = $row[1]>
              <input type="submit" name="add" value="Add user" style="background-color:green; color: white; margin-top: -20px;">
              <input type="submit" name="removeuser" value="Remove user" style="background-color:red; float: right;color: white; margin-top: -25px;">
              </form>
              </pre>
_END;
  
          if (isset($_POST['adduser']) && isset($_POST['email']) && isset($_POST['add'])) {
           $email = $_POST['email'];
           $sql_add = "Update user set authenticated = true, requestedAdd = false where email = '$email'";
           $result = $database->query($sql_add);
            redirect_to('adminpage.php');

            }


            if (isset($_POST['removeuser']) && isset($_POST['email'])) {
              $email = $_POST['email'];
              $sql_remove = "delete from user where email = '$email'";
              $result = $database->query($sql_remove);
              redirect_to('adminpage.php');

            }
         }

        ?>

         <h3 style="color: #ce0404">Pending User Added Virus: </h3><br>
         <?php 

         $sql_get_user_virus = "Select `name`, `signature` from usermalware";
         $result = $database->query($sql_get_user_virus);
         $rows = $database->num_rows($result);

        for ($j = 0 ; $j < $rows ; $j++)
            {
              $result->data_seek($j);
              $row = $result->fetch_array(MYSQLI_NUM);

              echo <<<_END
              <pre style = "margin-left: -50px; margin-bottom: 20px; width: 400px; text-align: left; height: 200px;">
              Malware Name: $row[0]
              Signature: $row[1]
              <form action="adminpage.php" method="post">
              <input type= "hidden" name = "signature" value = $row[1] >
              <input type="submit" name="submitmalware" value="Add Malware" style="background-color:green;color: white; margin-top: -20px;">
              <input type="submit" name="removemalware" value="Remove Malware" style="background-color:red; float: right;color: white; margin-top: -25px;"></form>
              </pre>

_END;
        if (isset($_POST['submitmalware']) && isset($_POST['signature'])) {
            $signature = $_POST['signature'];
            $sql_add = "delete from usermalware where signature = '$signature'";
            $result = $database->query($sql_add);
            redirect_to('adminpage.php');
          }
          echo ($_POST['removemalware']);
          if (isset($_POST['removemalware']) && isset($_POST['signature'])) {
            $signature = $_POST['signature'];
            $sql_remove = "delete from usermalware where signature = '$signature'";
            $result = $database->query($sql_remove);
            $sql_remove_again = "delete from malware where signature = '$signature'";
            $result = $database->query($sql_remove_again);
            redirect_to('adminpage.php');
          }
}

?>

        </div>
       
       </div>
        			 
 			 </div>
 		 
		</div>

		
  </div>
<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/bootstrap.min.js"></script>
    <script>   
		$(".contentContainer").css("min-height",$(window).height());
    </script>

    <script type="text/javascript">
    function submitForm(action) {
      var form = document.getElementById('form1');
      form.action = action;
      form.submit();
    }
    </script>
</body>
</html>


