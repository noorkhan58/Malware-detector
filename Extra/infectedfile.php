<?php
error_reporting(E_ERROR | E_PARSE);
require_once('functions.php');
require_once('connection.php');

echo <<<_END
   
    <!DOCTYPE html>
<html>
<head>
    <title>Malware infected file</title>
    <link href="main.css" media = "all" rel="stylesheet" type="text/css" />
</head>
<body>
    <div id = "header">
        <a href="index.php"><h1 style = "color = #D4E6F4;">Malware Detector</h1></a>
    </div>

    <div id="infectedfile">
        <form action="infectedfile.php" method="POST" enctype="multipart/form-data">
        <label style="font-size: 20px;">Enter malware name: </label>
        <input type="text" name="malware" id="inputmalware" > <br><br>
        <input type="file" name="file"><br><br>
        <input type="submit" name="Submit">
        </form>

</div>

</body>
</html>
_END;

function ascii2hex($ascii) {
  $hex = '';
  for ($i = 0; $i < strlen($ascii); $i++) {
    $byte = strtoupper(dechex(ord($ascii{$i})));
    $byte = str_repeat('0', 2 - strlen($byte)).$byte;
    $hex.=$byte." ";
  }
  return $hex;
}


    if (isset($_POST['Submit'])) {

    $file_name = $_FILES['file']['name'];
    $file_size = $_FILES['file']['size'];
    $file_type = $_FILES['file']['type'];
    $file_error = $_FILES['file']['error'];
    $file_contents = file_get_contents($_FILES['file']['tmp_name']);
    $malware_name = $_POST['malware'];
    $contents = "";

        //Checking file name is not empty
        if(isset($file_name) && !empty($file_name)) {

            if(!empty($malware_name)) {

                if (check_file_error($file_error)) {

                    if (check_file_size($file_size)) {

                       for($i = 0; $i < $file_size; $i++) { 

                            // get the current ASCII character representation of the current byte
                            $asciiCharacter = $file_contents[$i];

                            $contents .= ascii2hex($asciiCharacter);    
                        }
                        $contents = str_replace(' ', '', $contents);
                        $signature = $database->mysql_prep(substr($contents, 0, 20));
                        $sql = "insert into malware values('$malware_name', '$signature')";
                        $result = $database->query($sql);
                        echo "Successfully inserted";

                    }

                }
            }else {
                echo "Please enter malware name";
            }

        }else {
            echo "Please choose a file";
        }
    }


?>












